<!doctype html>
<!--[if lt IE 7 ]>
<html lang="en" class="ie6"> <![endif]-->
<!--[if IE 7 ]>
<html lang="en" class="ie7"> <![endif]-->
<!--[if IE 8 ]>
<html lang="en" class="ie8"> <![endif]-->
<!--[if IE 9 ]>
<html lang="en" class="ie9"> <![endif]-->
<!--[if !IE]><!-->
<html lang="en"> <!--<![endif]-->
<head>
    <meta name="viewport" content="width = 1050, user-scalable = no"/>    <!--전체 섹션 규격 & 유저 크기 조정 가능여부-->
    <script type="text/javascript" src="/lib/JQuery/jquery.min.1.7.js"></script>    <!--경로 & 실제 파일 존재여부 반드시 확인-->
    <script type="text/javascript" src="/lib/JQuery/modernizr.2.5.3.min.js"></script>    <!--경로 & 실제 파일 존재여부 반드시 확인-->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!--	<script type="text/javascript" src="../lib/JQuery/yepnope.js"></script>-->
    <!--	<script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/3.11.2/modernizr.min.js"></script>-->
    <link rel="stylesheet" type="text/css" href="/CSS/bookGuestBook.css">
    <link href='https://fonts.googleapis.com/css?family=Kaushan Script' rel='stylesheet'>

</head>
<body style="background-image: url(/img/mypageBackground.jpg); background-repeat: no-repeat ; background-size: cover;">
<div class="logo">
    <div class="logo" style="background-image: url(/img/mypageLogo.png);"></div>
</div>
<div class="myPageGoHome" style="background-image: url(/img/myPageGoHome.png)" onclick="window.location.href='/mypage/bookMain';"></div>
<div class="backgroundGuestBook" style="background-image: url(/img/addBook.png);"></div>

<!-- Guestbook Entries Section -->
<div id="guestbookEntries" style="margin-top: 20px;">
    <!-- New guestbook entries will be added here -->
</div>

<div class="flipbook-viewport">

    <div class="container">
        <div class="flipbook">
            <div class="titleBook" style="background-image:url(/img/titleGuestBook.png)"></div>
            <!--배경이미지 설정 부분 (여권사진 홀수번 우측, 짝수번 좌측 화면 표시 예정)-->
<!--            <div class="leftBook" id="leftBookPage1" style="background-image:url(/img/sample_left.png)"></div>-->
<!--            <div class="rightBook" id="leftBookPage2" style="background-image:url(/img/sample_right.png)"></div>-->

        </div>
    </div>
</div>
<div class="menu1" id="1" style="background-image: url(/img/mypageMenu.png);"><h4 id="Post">&nbsp;Invoice</h4></div>
<div class="menu2" id="2" style="background-image: url(/img/mypageMenu.png);"><h4 id="PostLiked">&nbsp;Post</h4></div>
<div class="menu3" id="3" style="background-image: url(/img/mypageMenu.png);"><h4 id="GuestBook">&nbsp;Post♥</h4></div>
<div class="menu4" id="4" style="background-image: url(/img/mypageMenu.png);"><h4 id="PackageLiked">&nbsp;Package♥</h4>
</div>
<div class="menu5" id="5" style="background-image: url(/img/mypageMenu.png);"><h4 id="Invoice">&nbsp;GuestBook</h4>
</div>
<div class="goChat" style="background-image: url(/img/mypageChat.png);"></div>

<div class="writeGuestBook" style="background-image: url(/img/addbutton.png)"></div>
<div class="addGuestBookModal">
    <div class="modalContent">
        <button class="closeModal">Close</button>
        <h3>Write Your Guestbook</h3>
        <label for="guestName">Name:</label>
        <input type="text" id="guestName" placeholder="Enter your name">
        <label for="guestMessage">Message:</label>
        <textarea id="guestMessage" placeholder="Write a message"></textarea>
        <button id="submitGuestBook">Submit</button>
    </div>
</div>


</div>


</div>
<script type="text/javascript">
    $(document).ready(function () {

        const apiUrl = "/bookMain/bookGuestBook"; // API URL 설정

        // 앱 로드 및 초기화
        initializeApp();

        function initializeApp() {
            checkAndLoadFlipbook();
            loadGuestBooks();

            // 방명록 작성 모달 처리
            $('.writeGuestBook').click(() => $('.addGuestBookModal').show());
            $('.closeModal').click(() => $('.addGuestBookModal').hide());

            // 유저 정보 수정 모달 처리
            $('.myPageUpdate').click(() => $('.updateUserModal').show());
            $('.closeUpdateModal').click(() => $('.updateUserModal').hide());

            // 방명록 추가 처리
            $('#submitGuestBook').click(submitGuestBook);

            // 채팅 hover 효과
            $('.goChat').hover(() => hoverChat());
        }

        // Flipbook 초기화
        function checkAndLoadFlipbook() {
            if (isCSSTransformSupported()) {
                $.getScript('/lib/animationjs/turn.js', () => loadApp());
            } else {
                $.getScript('../../lib/JQuery/turn.html4.min.js', () => loadApp());
            }
        }

        function loadApp() {
            $('.flipbook').turn({
                width: 922,
                height: 600,
                elevation: 50,
                gradients: true,
                autoCenter: false,
                display: 'double',
                // page: 1,
                first: true
            });
        }

        // CSS Transform 지원 여부 확인
        function isCSSTransformSupported() {
            const testElement = document.createElement('div');
            const transformProperties = ['transform', 'WebkitTransform', 'MozTransform', 'OTransform', 'msTransform'];
            return transformProperties.some(prop => testElement.style[prop] !== undefined);
        }

        // URL에서 toUserId 값 추출하는 함수
        function getToUserIdFromUrl() {
            const pathParts = window.location.pathname.split('/');
            const toUserId = pathParts[pathParts.length - 1]; // 마지막 부분이 toUserId
            return toUserId;
        }

        // 방명록 불러오기
        function loadGuestBooks() {
            console.log("loadGuestBooks 작동");

            const toUserId = getToUserIdFromUrl();

            $.get(`${apiUrl}/list/${toUserId}`, function (data) {
                console.log("Loaded guestbooks:", data);

                // 기존 페이지 삭제 및 초기화
                resetFlipbook();

                // 데이터를 페이지에 추가
                data.forEach((guestBook, index) => {
                    const entryHtml = `
                        <div class="guestbook-entry">
                            <h4>From: ${guestBook.fromUserId}</h4>
                            <p>${guestBook.guestBookContent}</p>
                        </div>`;
                    addEntryToPage(entryHtml, index + 1); // index + 1을 이용하여 페이지에 추가
                    console.log(`Guestbook Entry ${index + 1} added to page ${currentPage}`);
                });
            });
        }

        // 기존 페이지 삭제
        function resetFlipbook() {
            console.log("resetFlipbook 작동");
            $('.flipbook').turn('pages', 0);  // 기존 페이지 초기화
            $('#guestbookEntries').empty();  // 기존 목록 초기화
            currentPage = 1;  // 페이지 번호 초기화
            pages = { 1: 0 }; // 각 페이지 항목 개수 초기화
        }

        // 방명록 추가
        function submitGuestBook() {
            console.log("submit 작동");
            const name = $('#guestName').val();
            const message = $('#guestMessage').val();

            if (name && message) {
                const guestBookData = {
                    toUserId: getToUserIdFromUrl(),
                    fromUserId: 2,
                    guestBookContent: message
                };

                $.ajax({
                    url: `${apiUrl}/add`,
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(guestBookData),
                    success: function () {
                        console.log("succes 진입")
                        loadGuestBooks(); // 추가된 방명록 반영
                        resetGuestBookForm();
                    },
                    error: function () {
                        alert("Failed to add the guest book entry.");
                    }
                });
            } else {
                alert("Please fill in both fields!");
            }
        }

        // 방명록 입력 필드 초기화
        function resetGuestBookForm() {
            console.log("폼 초기화 작동");

            $('#guestName').val('');
            $('#guestMessage').val('');
            $('.addGuestBookModal').hide();
        }

        // 항목을 페이지에 추가
        const entriesPerPage = 3; // 페이지당 항목 개수
        let currentPage = 1;      // 현재 페이지 번호
        let pages = { 1: 0 }; // 각 페이지 항목 개수

        function addEntryToPage(entry, index) {
            console.log("addEntry 작동");

            // 랜덤 배경 이미지 설정
            const entryWithBackground = setRandomBackgroundImage(entry);

            // 현재 페이지가 없으면 새 페이지 생성
            if (!$(`#page${currentPage}`).length) {
                createNewPage(); // 첫 페이지 생성
            }


            // 현재 페이지에 추가 가능한 경우
            if (pages[currentPage] < entriesPerPage) {
                $(`#page${currentPage}`).append(entryWithBackground);
                pages[currentPage]++;
                console.log(`Entry added to Page ${currentPage}, Position: ${pages[currentPage]}`);
            } else {
                // 현재 페이지가 가득 찼으면 새 페이지 생성 후 추가
                currentPage++; // 새로운 페이지 번호
                createNewPage();
                $(`#page${currentPage}`).append(entryWithBackground);
                pages[currentPage] = 1; // 새 페이지 첫 번째 항목
                console.log(`Entry added to new Page ${currentPage}, Position: ${pages[currentPage]}`);
            }
        }

        // 현재 페이지가 꽉 차지 않았다면 항목 추가
        //     if (pages[currentPage] < entriesPerPage) {
        //         $(`#page${currentPage}`).append(entryWithBackground);
        //         pages[currentPage]++;
        //         console.log(`Entry added to Page ${currentPage}, Position: ${pages[currentPage]}`);
        //     } else {
        //         // 이곳 부터 TODO
        //         currentPage++; // 새로운 페이지로 이동
        //         createNewPage(entryWithBackground);
        //         console.log(`Page ${currentPage} created due to overflow`);
        //     }
        // }

        // 새 페이지 생성 및 항목 추가
        function createNewPage(entry) {
            console.log("createpage 작동");
            const totalPages = $('.flipbook').turn('pages');
            currentPage = totalPages + 1; // 페이지 번호 계산

            console.log(`New page created. Total Pages: ${totalPages}, Current Page: ${currentPage}`);

            // 새 페이지를 flipbook에 추가
            const newPage = `<div class="page" id="page${currentPage}" style="background-image:url(/img/addBook.png)"></div>`;
            $('.flipbook').turn('addPage', $(newPage)[0], currentPage);


            pages[currentPage] = 0;
            console.log(`New Page ${currentPage} created`);

            // 새 페이지에 항목 추가
            // $(`#page${currentPage}`).append(entry);
            // pages[currentPage] = 1;  // 새 페이지 첫 번째 항목
            // console.log(`Entry added to new Page ${currentPage}, Position: ${pages[currentPage]}`);
            // $('.flipbook').turn('resize');  // 페이지 크기 조정
        }

        // 랜덤 배경 이미지 설정
        function setRandomBackgroundImage(entry) {
            const images = [
                'url(/img/stamp1.png)',
                'url(/img/stamp2.png)',
                'url(/img/stamp3.png)',
                'url(/img/stamp4.png)',
                'url(/img/stamp5.png)'
            ];
            const randomImage = images[Math.floor(Math.random() * images.length)];

            // entry에 배경 이미지 스타일 적용
            const entryWithBackground = $(entry).css('background-image', randomImage);
            return entryWithBackground;
        }

        // 채팅 hover 효과
        function hoverChat() {
            let angle = 0;
            let shakeInterval = setInterval(() => {
                angle += 10;
                $('.goChat').css('transform', `rotateY(${angle}deg)`);
                if (angle >= 35) {
                    clearInterval(shakeInterval);
                    $('.goChat').css('transform', 'rotateY(0deg)');
                }
            }, 100);
        }
    });
</script>


</body>
</html>